<!DOCTYPE html>
<html>
<head>
  <title>Maps (Seoul)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #map { height: 70vh; width: 100%; }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <!-- 🔙 상단 뒤로가기 + 제목 -->
  <div class="flex items-center justify-between max-w-md mx-auto mb-4">
    <button onclick="goHome()" class="text-sm text-blue-600 hover:underline">← Back</button>
    <h1 class="text-xl font-bold text-center flex-1 -ml-6">📍 Maps</h1>
  </div>

  <!-- 목적지 버튼 -->
  <div class="grid grid-cols-2 gap-4 mb-4 max-w-md mx-auto">
    <button onclick="focusDest('shilla')" class="bg-white py-2 px-4 rounded shadow hover:bg-gray-200">🏨 The Shilla Seoul</button>
    <button onclick="focusDest('digitalcity')" class="bg-white py-2 px-4 rounded shadow hover:bg-gray-200">🏢 Samsung Digital City</button>
    <button onclick="focusDest('umyeonrnd')" class="bg-white py-2 px-4 rounded shadow hover:bg-gray-200">🧪 Umyeon R&amp;D Campus</button>
    <button onclick="focusDest('hyundae')" class="bg-white py-2 px-4 rounded shadow hover:bg-gray-200">🛍️ The Hyundai Seoul</button>
    <button onclick="focusDest('housenowhere')" class="bg-white py-2 px-4 rounded shadow hover:bg-gray-200">🧱 House Nowhere Seoul</button>
  </div>

  <!-- 정보 표기 -->
  <div id="routeInfo" class="text-center text-sm text-gray-700 mt-2 mb-4 whitespace-pre-line"></div>

  <!-- 지도 -->
  <div id="map" class="rounded shadow"></div>

  <script>
    // ✅ 목적지 좌표
    const destinations = {
      shilla:      { lat: 37.555890, lng: 127.005150, name: "The Shilla Seoul" },
      digitalcity: { lat: 37.256910, lng: 127.051260, name: "Samsung Digital City (Suwon)" },
      umyeonrnd:   { lat: 37.465110, lng: 127.023470, name: "Umyeon R&D Campus" },
      hyundae:     { lat: 37.525960, lng: 126.928420, name: "The Hyundai Seoul (Yeouido)" },
      housenowhere:{ lat: 37.537973, lng: 127.058702, name: "House Nowhere Seoul (Seongsu)" }
    };

    let map, infoWindow;
    let myPos = null;            // {lat, lng} or null
    const destMarkers = {};      // key -> Marker
    const routeInfoDiv = document.getElementById("routeInfo");

    // 📐 Haversine 직선거리(m)
    function haversine(a, b){
      const R = 6371000; // m
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    const fmtKm = (m)=> (m < 1000 ? `${Math.round(m)} m` : `${(m/1000).toFixed(1)} km`);

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: 37.5665, lng: 126.9780 } // 서울 시청 부근
      });
      infoWindow = new google.maps.InfoWindow();

      // 목적지 마커 찍기
      Object.entries(destinations).forEach(([key, d]) => {
        const marker = new google.maps.Marker({
          position: d,
          map,
          title: d.name
        });
        marker.addListener('click', () => openDestInfo(key));
        destMarkers[key] = marker;
      });

      // 내 위치 마커 (권한 허용 시에만)
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            new google.maps.Marker({
              position: myPos,
              map,
              title: "You are here",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeColor: "#ffffff",
                strokeWeight: 2
              }
            });
            fitAllMarkers();
            routeInfoDiv.innerText = "Showing your current location and selected destinations.";
          },
          (err) => {
            console.warn("Geolocation error:", err);
            fitAllMarkers(); // 내 위치 없이 목적지만 보기
            routeInfoDiv.innerText = "Location access denied. Showing destinations only.";
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      } else {
        fitAllMarkers();
        routeInfoDiv.innerText = "Geolocation not supported. Showing destinations only.";
      }
    }

    function fitAllMarkers(){
      const bounds = new google.maps.LatLngBounds();
      Object.values(destMarkers).forEach(m => bounds.extend(m.getPosition()));
      if (myPos) bounds.extend(myPos);
      map.fitBounds(bounds, 64);
    }

    function openDestInfo(key){
      const d = destinations[key];
      let html = `<div style="min-width:180px"><strong>${d.name}</strong>`;
      if (myPos) {
        const dist = haversine(myPos, d);
        html += `<br/>Distance from you: <b>${fmtKm(dist)}</b>`;
      } else {
        html += `<br/><em>Enable location to see distance.</em>`;
      }
      html += `</div>`;
      infoWindow.setContent(html);
      infoWindow.open({ map, anchor: destMarkers[key] });
      map.panTo(d);
    }

    function focusDest(key){
      // 버튼용: 해당 목적지로 포커스 + 인포윈도 열기
      openDestInfo(key);
    }
  </script>

  <!-- ✅ Google Maps API (HTTPS/localhost 권장) -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfHkgQ8w0T0-JlGESZiLbFAAgULg46I4A&callback=initMap">
  </script>

  <script>
    function goHome() { window.location.href = "index.html"; }
  </script>
</body>
</html>
