<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Samsung LATAM Forum — Survey</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .tap {min-height: 56px}
    .choice[aria-checked="true"]{outline:2px solid #111827; box-shadow: inset 0 0 0 2px #111827}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="mb-4 sm:mb-6">
      <h1 class="text-3xl sm:text-4xl font-bold mt-3 mb-4">Survey</h1>
      <p class="text-lg leading-7 text-slate-800">
        We hope you had a great time at <span class="font-semibold">Journey of Inspiration</span>.
      </p>
      <p class="text-lg leading-7 text-slate-700">
        Please complete the survey by selecting your answers. For rating questions, <span class="font-semibold">tap a number (0–10)</span>; for text questions, type your comments. <span class="text-slate-500">(On mobile, just tap to select.)</span>
      </p>
    </header>

    <!-- Progress -->
    <div class="mb-4" aria-label="Progress">
      <div class="flex justify-between text-sm font-medium text-slate-600 mb-1">
        <span id="progressLabel">Step 1 of 5</span>
        <span id="progressPct">0%</span>
      </div>
      <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
        <div id="progressBar" class="h-3 bg-blue-600 w-0"></div>
      </div>
    </div>

    <!-- Form -->
    <form id="surveyForm" class="bg-white rounded-2xl shadow p-4 sm:p-6 space-y-6" novalidate>
      <!-- Step 1: About You -->
      <section class="step" data-step="1">
        <h2 class="text-2xl font-semibold mb-2">About you</h2>
        <p class="text-slate-600 mb-4">Choose your Samsung subsidiary and group.</p>

        <!-- Subsidiary -->
        <label class="block text-lg font-medium mb-2">From which Samsung subsidiary are you from?<span class="text-red-600"> *</span></label>
        <div id="subsidiary" class="grid grid-cols-1 gap-2" role="radiogroup" aria-labelledby="subsidiary">
          <!-- options -->
        </div>

        <!-- Group -->
        <label class="block text-lg font-medium mt-6 mb-2">Which group do you represent?<span class="text-red-600"> *</span></label>
        <div id="group" class="grid grid-cols-1 gap-2" role="radiogroup" aria-labelledby="group">
          <!-- options -->
        </div>
      </section>

      <!-- Step 2: Overall Enjoyment -->
      <section class="step hidden" data-step="2">
        <h2 class="text-2xl font-semibold mb-2">Overall</h2>
        <p class="text-slate-600 mb-4">Tap a number (0–10). Bigger = better.</p>
        <div class="space-y-6">
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Journey of Inspiration — LATIN CEO CONFERENCE</label>
            <div class="likert" data-key="overall_forum"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Samsung Digital City visit</label>
            <div class="likert" data-key="digital_city"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Business Meetings</label>
            <div class="likert" data-key="meetings"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Gala Dinner</label>
            <div class="likert" data-key="gala"></div>
          </div>
        </div>
      </section>

      <!-- Step 3: Hospitality -->
      <section class="step hidden" data-step="3">
        <h2 class="text-2xl font-semibold mb-2">Hospitality</h2>
        <div class="space-y-6">
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Busan Hospitality day</label>
            <div class="likert" data-key="busan_day"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Seoul Hospitality day</label>
            <div class="likert" data-key="seoul_day"></div>
          </div>
        </div>
      </section>

      <!-- Step 4: Food & Beverage -->
      <section class="step hidden" data-step="4">
        <h2 class="text-2xl font-semibold mb-2">Food & Beverage</h2>
        <div class="space-y-6">
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Welcome Dinner</label>
            <div class="likert" data-key="welcome_dinner"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Busan Lunch</label>
            <div class="likert" data-key="busan_lunch"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Busan Happy Hour</label>
            <div class="likert" data-key="busan_happy"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Seoul Lunch</label>
            <div class="likert" data-key="seoul_lunch"></div>
          </div>
          <div>
            <label class="block font-semibold mb-2 text-xl sm:text-2xl">Seoul Dinner</label>
            <div class="likert" data-key="seoul_dinner"></div>
          </div>
        </div>
      </section>

      <!-- Step 5: Comments & When/Where -->
      <section class="step hidden" data-step="5">
        <h2 class="text-2xl font-semibold mb-2">Final</h2>
        <div class="space-y-4">
          <label class="block">
            <span class="block font-semibold mb-2 text-xl sm:text-2xl">Any additional comments and/or suggestions?</span>
            <textarea id="comments" class="w-full rounded-xl border border-slate-300 p-3 text-lg" rows="4" placeholder="Type here…"></textarea>
          </label>
          <label class="block">
            <span class="block font-semibold mb-2 text-xl sm:text-2xl">When would you suggest having the next LATIN CEO CONFERENCE?</span>
            <input id="next_when" type="text" class="w-full rounded-xl border border-slate-300 p-3 text-lg" placeholder="e.g., July 2026"/>
          </label>
          <label class="block">
            <span class="block font-semibold mb-2 text-xl sm:text-2xl">Where would you suggest having the next LATIN CEO CONFERENCE?</span>
            <input id="next_where" type="text" class="w-full rounded-xl border border-slate-300 p-3 text-lg" placeholder="e.g., São Paulo"/>
          </label>
        </div>
      </section>

      <!-- Nav -->
      <div class="flex items-center justify-between pt-2">
        <button type="button" id="btnPrev" class="tap px-4 py-3 rounded-xl bg-slate-200 text-slate-900 font-semibold disabled:opacity-40">◀ Previous</button>
        <button type="button" id="btnSave" class="tap px-4 py-3 rounded-xl bg-amber-100 text-amber-900 font-semibold">Save and resume later</button>
        <button type="button" id="btnNext" class="tap px-5 py-3 rounded-xl bg-blue-600 text-white font-semibold">Next ▶</button>
        <button type="submit" id="btnSubmit" class="tap px-5 py-3 rounded-xl bg-emerald-600 text-white font-semibold hidden">Submit</button>
      </div>

      <p id="helper" class="text-center text-slate-600 text-sm">You can come back later. Your progress is saved on this device.</p>
    </form>

    <footer class="text-center text-xs text-slate-500 mt-6">Journey of Inspiration</footer>
  </main>

  <script>
  /********************
   * 0) APPS SCRIPT ENDPOINT (Google Sheets Web App)
   ********************/
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhGYQHjKlu_-pDoRICo6BYRYYOPc-jmrBFte6-kt28JcYB8RNC3iPmgGw6r_5vji2hhA/exec';
    const SHARED_SECRET = 'LATAM2025_SECRET_987xyz'; // GAS 코드의 SHARED_SECRET와 반드시 동일
    // —— 로컬스토리지 키들 ——
    const LS_PENDING_KEY   = 'survey_pending_payload_v1';  // 제출 실패 시 임시보관 페이로드
    const LS_SUBMIT_ID_KEY = 'survey_submit_id_v1';        // 이번 제출의 UUID(성공 시 삭제)


  /********************
   * 1) INIT
   ********************/
  const form = document.getElementById('surveyForm');
  const steps = Array.from(document.querySelectorAll('.step'));
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnSubmit = document.getElementById('btnSubmit');
  const btnSave = document.getElementById('btnSave');
  const progressBar = document.getElementById('progressBar');
  const progressLabel = document.getElementById('progressLabel');
  const progressPct = document.getElementById('progressPct');

  const LS_KEY = 'survey_draft_v1';
  const state = loadDraft() || { step:1, data:{} };

  // ✅ 필수 항목 정의
  const REQUIRED_KEYS_BY_STEP = {
    1: ['subsidiary','group'],
    2: ['overall_forum','digital_city','meetings','gala'],
    3: ['busan_day','seoul_day'],
    4: ['welcome_dinner','busan_lunch','busan_happy','seoul_lunch','seoul_dinner'],
    5: [],
  };

  const LABEL_BY_KEY = {
    subsidiary: 'Subsidiary',
    group: 'Group',
    overall_forum: 'Overall — Forum',
    digital_city: 'Samsung Digital City',
    meetings: 'Business Meetings',
    gala: 'Gala Dinner',
    busan_day: 'Busan Hospitality day',
    seoul_day: 'Seoul Hospitality day',
    welcome_dinner: 'Welcome Dinner',
    busan_lunch: 'Busan Lunch',
    busan_happy: 'Busan Happy Hour',
    seoul_lunch: 'Seoul Lunch',
    seoul_dinner: 'Seoul Dinner',
    comments: 'Comments',
    next_when: 'Next Forum — When',
    next_where: 'Next Forum — Where',
  };

  // —— UUID 생성 (브라우저가 지원하면 crypto.randomUUID 사용) ——
    function uuid() {
      if (crypto.randomUUID) return crypto.randomUUID();
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(
        /[018]/g,
        c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)
      );
    }

    // —— 제출용 UUID를 만들고 보관/재사용 ——
    // (성공할 때까지 같은 ID 재사용 → 서버에서 중복 저장 방지)
    function getOrCreateSubmitId() {
      let id = localStorage.getItem(LS_SUBMIT_ID_KEY);
      if (!id) {
        id = uuid();
        localStorage.setItem(LS_SUBMIT_ID_KEY, id);
      }
      return id;
    }
    function clearSubmitId() {
      localStorage.removeItem(LS_SUBMIT_ID_KEY);
    }

    // —— 지수 백오프 재시도: 5xx/네트워크 오류만 재시도, 4xx는 즉시 실패 ——
    // tries: 시도 횟수, baseDelay: 최초 대기(ms). 각 회마다 x2 + 랜덤 지터
    async function postJSON(url, body, tries = 3, baseDelay = 500) {
      for (let i = 0; i < tries; i++) {
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(body),
          });
          if (res.ok) return res.json();

          // 5xx는 재시도 대상
          if (res.status >= 500) throw new Error('server ' + res.status);

          // 4xx는 즉시 실패(재시도 무의미)
          const t = await res.text();
          throw new Error('HTTP ' + res.status + ' ' + t);

        } catch (err) {
          if (i === tries - 1) throw err;
          const jitter = Math.floor(Math.random() * 150); // 0~149ms 지터
          await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, i) + jitter));
        }
      }
    }


  // ✅ 유틸 함수
  function isEmptyValue(v){
    if (v === undefined || v === null) return true;
    if (typeof v === 'string' && v.trim() === '') return true;
    return false;
  }

  function highlightMissing(keys){
    keys.forEach(k=>{
      const likert = document.querySelector(`.likert[data-key="${k}"]`);
      if(likert){
        likert.classList.add('ring-2','ring-red-500','rounded-xl');
        setTimeout(()=>likert.classList.remove('ring-2','ring-red-500'), 1800);
        return;
      }
      const input = document.getElementById(k);
      if(input){
        input.classList.add('border-red-500');
        setTimeout(()=>input.classList.remove('border-red-500'), 1800);
        return;
      }
      const radios = document.querySelectorAll(`.choice[data-name="${k}"]`);
      if(radios.length){
        radios.forEach(el=>el.classList.add('ring-2','ring-red-500','rounded-xl'));
        setTimeout(()=>radios.forEach(el=>el.classList.remove('ring-2','ring-red-500')), 1800);
      }
    });
  }

  function validateStep(stepNum){
    const required = REQUIRED_KEYS_BY_STEP[stepNum] || [];
    const missing = required.filter(k => isEmptyValue(state.data[k]));
    if(missing.length){
      highlightMissing(missing);
      const names = missing.map(k=>LABEL_BY_KEY[k] || k).join(', ');
      alert(`Please complete: ${names}`);
      return false;
    }
    return true;
  }

  // ------------------------------
  // Options data (여기는 딱 한 번만!)
  const subsidiaries = [
    'Argentina, Uruguay, Paraguay', 'Brazil',
    'Central America, Caribbean, Miami',
    'Chile, Bolivia', 'Colombia', 'Mexico', 'Peru',
    'LAO (RHQ)', 'Korea (HQ)'
  ];
  const groups = ['Retailer','Samsung'];


  // Render subsidiary & group choices
  const asRadio = (name, value) => {
    const id = `${name}_${value.replace(/[^a-z0-9]/gi,'_')}`;
    return `\n<label class="choice flex items-center gap-3 border rounded-xl p-3 tap cursor-pointer" tabindex="0" role="radio" aria-checked="false" data-name="${name}" data-value="${value}">\n  <span class="w-6 h-6 rounded-full border flex items-center justify-center bg-white"><span class="dot w-3 h-3 rounded-full bg-blue-600 opacity-0"></span></span>\n  <span class="text-lg">${value}</span>\n</label>`
  }
  document.getElementById('subsidiary').innerHTML = subsidiaries.map(v => asRadio('subsidiary', v)).join('');
  document.getElementById('group').innerHTML = groups.map(v => asRadio('group', v)).join('');

  // Restore selections if any
  function restoreRadios(){
    document.querySelectorAll('.choice').forEach(el=>{
      const name = el.dataset.name; const value = el.dataset.value;
      const on = state.data[name] === value;
      el.setAttribute('aria-checked', on? 'true':'false');
      el.querySelector('.dot').style.opacity = on? '1':'0';
    });
  }

  // Radio interactions (big tap labels)
  document.addEventListener('click', (e)=>{
    const label = e.target.closest('.choice');
    if(!label) return;
    const name = label.dataset.name;
    const value = label.dataset.value;
    state.data[name] = value;
    // clear others
    document.querySelectorAll(`.choice[data-name="${name}"]`).forEach(el=>{
      const on = el===label;
      el.setAttribute('aria-checked', on? 'true':'false');
      el.querySelector('.dot').style.opacity = on? '1':'0';
    });
    saveDraft();
  });

  // Likert 0-10 renderers
  function renderLikerts(){
    document.querySelectorAll('.likert').forEach(box=>{
      const key = box.dataset.key;
      const cur = state.data[key];
      const row = document.createElement('div');
      row.className = 'grid grid-cols-6 sm:grid-cols-11 gap-2';
      for(let i=0;i<=10;i++){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'tap w-full rounded-xl border p-4 text-2xl font-semibold bg-white flex items-center justify-center text-center leading-none';
        b.textContent = i;
        if(cur===i) b.classList.add('!bg-blue-600','!text-white');
        b.addEventListener('click', ()=>{
          state.data[key] = i;
          saveDraft();
          // highlight
          row.querySelectorAll('button').forEach(x=>x.classList.remove('!bg-blue-600','!text-white'));
          b.classList.add('!bg-blue-600','!text-white');
        });
        row.appendChild(b);
      }
      box.innerHTML=''; box.appendChild(row);
    });
  }

  // Comments inputs bind
  ['comments','next_when','next_where'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', ()=>{ state.data[id]=el.value; saveDraft(); });
  });

  // Stepper
  function showStep(n){
    state.step = Math.max(1, Math.min(5, n));
    steps.forEach(s=> s.classList.toggle('hidden', Number(s.dataset.step)!==state.step));
    btnPrev.disabled = state.step===1;
    btnNext.classList.toggle('hidden', state.step===5);
    btnSubmit.classList.toggle('hidden', state.step!==5);
    const pct = Math.round((state.step-1)/(steps.length-1)*100);
    progressBar.style.width = pct+'%';
    progressLabel.textContent = `Step ${state.step} of ${steps.length}`;
    progressPct.textContent = `${pct}%`;
    saveDraft();
  }

  btnPrev.addEventListener('click', ()=> showStep(state.step-1));

  btnNext.addEventListener('click', ()=>{
    // 현재 단계 유효성 검사
    if (!validateStep(state.step)) return;
    showStep(state.step + 1);
  });
  btnSave.addEventListener('click', ()=>{
    saveDraft();
    alert('Saved on this device. You can close and come back later.');
  });

  // Submit handler — Google Sheets (Apps Script Web App)
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 모든 단계(1~5) 검사
    for (let s = 1; s <= 5; s++) {
      if (!validateStep(s)) {
        showStep(s); // 미입력 단계로 이동
        return;
      }
    }

    // —— 이번 제출의 UUID(멱등 키) 확보 —— 
    const submitId = getOrCreateSubmitId();

    // —— 페이로드 구성 + 먼저 로컬에 보관(오프라인/실패 대비) ——
    const payload = {
      id: submitId,                                // ★ 서버로도 전송됨(중복 방지)
      ...state.data,
      created_at: new Date().toISOString(),
      user_agent: navigator.userAgent,
      _secret: SHARED_SECRET
    };
    localStorage.setItem(LS_PENDING_KEY, JSON.stringify(payload));

    toggleLoading(true);
    try {
      // —— 지수 백오프 재시도 사용 —— 
      const json = await postJSON(APPS_SCRIPT_URL, payload, /*tries*/3, /*baseDelay*/500);
      if (!json.ok) throw new Error('Submission failed');

      // —— 성공: 모든 로컬 데이터 정리 —— 
      localStorage.removeItem(LS_KEY);         // 작성 중 임시저장
      localStorage.removeItem(LS_PENDING_KEY); // 실패 보관 페이로드
      clearSubmitId();                         // 이번 제출 UUID 제거

      toggleLoading(false);
      alert('Thank you! Your response has been submitted.');
      window.location.assign('thankyou.html');

    } catch (err) {
      toggleLoading(false);
      console.error(err);

      // —— 실패: 페이로드는 이미 LS_PENDING_KEY에 보관됨 —— 
      // 다음에 페이지를 다시 열거나, Submit을 다시 누르면 postJSON으로 재시도됩니다.
      alert('Network or server issue.\nYour response is saved on this device and will retry automatically next time you open this page or press Submit again.');
    }
  });


  function toggleLoading(on){
    [btnPrev,btnNext,btnSubmit,btnSave].forEach(b=> b.disabled = !!on);
    btnSubmit.textContent = on? 'Submitting…': 'Submit';
  }

  function saveDraft(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadDraft(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; } }


  // —— 부팅 시, 로컬에 실패 저장된 응답이 있으면 자동 재전송(1회) ——
    async function tryResendPending() {
      const raw = localStorage.getItem(LS_PENDING_KEY);
      if (!raw) return; // 실패 보관 데이터 없으면 아무것도 안 함

      try {
        const payload = JSON.parse(raw);
        const json = await postJSON(APPS_SCRIPT_URL, payload, /*tries*/3, /*baseDelay*/500);
        if (json && json.ok) {
          // 성공 시: 로컬 정리
          localStorage.removeItem(LS_KEY);
          localStorage.removeItem(LS_PENDING_KEY);
          clearSubmitId();

          // 사용자 안내 + 완료 페이지 이동
          alert('Your previously saved response has been submitted. Thank you!');
          window.location.assign('thankyou.html');
        }
      } catch (e) {
        // 조용히 실패: 네트워크가 아직 불안정하면 사용자 Submit 시 다시 재시도됨
        console.warn('Auto-resend failed:', e);
      }
    }


  // Boot
  restoreRadios();
  renderLikerts();
  // restore text
  ['comments','next_when','next_where'].forEach(id=>{ const v = state.data[id]; if(v) document.getElementById(id).value = v; });
  showStep(state.step||1);

  // ★ 자동 재전송 시도(있으면 1회만)
  tryResendPending();

  </script>

  <!--
  NOTE:
  - Firebase 저장 대신 Google Sheets Web App으로 전송합니다.
  - thankyou.html은 동일 경로에 파일을 만들어 사용하세요(간단한 "감사합니다" 페이지).
  -->
</body>
</html>
